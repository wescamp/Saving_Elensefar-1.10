#textdomain wesnoth-Saving_Elensefar

#define WHAT_TURN
    [set_variable]
        name=timer
        value=$turn_number
    [/set_variable]
#enddef

[scenario]
    id=sea_voyage_0
    name= _ "The High Seas"
    map_data="{~add-ons/Saving_Elensefar/maps/The_High_Seas.map}"
    {SCENARIO_MUSIC revelation.ogg}
    turns=30
    victory_when_enemies_defeated=no

    {SE_SCHEDULE main}

    [side]
        {MENELDUR_SIDE}
        shroud=yes
        fog=yes
        village_gold=0
        income=-2
    [/side]

    [side]
        side=2
        no_leader=yes
        controller=ai
        [ai]
            aggression=1.0
            caution=0.0
            village_value=0.0001
        [/ai]
    [/side]

    [event]
        name=prestart

        [objectives]
            side=1
            victorystring= "<span size='large' color='green'>"+ _"Scenario Rules:"+"</span>"
            [objective]
                description="<span color='white'>"+ _"Land in a <i>harbor</i> to reprovision."+"</span>"
                condition=win
            [/objective]
            [objective]
                description="<span color='white'>"+ _"The Wesnothian ships are chasing you; if they attack you they will attempt to board the ship."+"</span>"
                condition=win
            [/objective]
            [objective]
                description="<span color='white'>"+ _"Each of their ships has enough provisions to completely restock your ship."+"</span>"
                condition=win
            [/objective]
            [objective]
                description="<span color='white'>"+ _"Your long-term objective is to <b>reach the lands in the West</b> where Black the Red says there are allies, and have them join you."+"</span>"
                condition=win
            [/objective]
            [objective]
                description="<span color='white'>"+ _"Until then you <b>cannot return</b> to Elensefar."+"</span>"
                condition=win
            [/objective]
            [objective]
                description="<span color='white'>"+ _"Be at sea for <i>6 weeks</i> (6 turns) without reprovisioning"+"</span>"
                condition=lose
            [/objective]
            [objective]
                description="<span color='white'>"+ _"Take more than <b>30 weeks</b> to reach the western lands"+"</span>"
                show_turn_counter=yes
                condition=lose
            [/objective]
        [/objectives]
    [/event]

#define GUARDSHIP X Y
    [unit]
        x,y={X},{Y}
        type=War Galleon
        side=2
        ai_special=guardian
    [/unit]
#enddef

    #stores the hex fields discovered
    [event]
        name=moveto
        first_time_only=no

        [filter]
            side=1
        [/filter]

        {VARIABLE_OP i to_variable store.length}

        {VARIABLE_OP store[$i].x to_variable x1}
        {VARIABLE_OP store[$i].y to_variable y1}
    [/event]

    [event]
        name=prestart

        {KILL_MENELDUR}

        #!explorers are placed everywere on map were the player has moved
        {FOREACH store n}
            {VARIABLE_OP xnow to_variable store[$n].x}
            {VARIABLE_OP ynow to_variable store[$n].y}
            [unit]
                x=$xnow
                y=$ynow
                side=1
                type=Black Galleon
            [/unit]
        {NEXT n}

        #! update shrouddata
        [redraw]
            side=1
        [/redraw]

        #! and of course kiled right away, they just are used as shroudclearers
        [kill]
            type=Black Galleon
        [/kill]

        #no turn limit but turns are limited, IF you did not run away the previous scenario
        [if]
            [variable]
                name=retreatednotwon
                equals=yes
            [/variable]
            [then]
                [set_variable]
                    name=retreatednotwon
                    value=no
                [/set_variable]
            [/then]
            [else]
                [set_variable]
                    name=turnsleft
                    value=6
                [/set_variable]
            [/else]
        [/if]
        [set_variable]
            name=revisiting
            value=no
        [/set_variable]

        #should not have recruits carry over from scen. to scen.
        [set_recruit]
            side=1
            recruit=
        [/set_recruit]

        #for easier planning for the player
        [modify_turns]
            value=30
            current=$timer
        [/modify_turns]
        [set_variable]
            name=gameleft
            value="$(31-$turn_number)"
        [/set_variable]

        #various items
        [item]
            x,y=57,3
            image=scenery/wreck.png
        [/item]

        #the royal navy of Wesnoth.
        {GUARDSHIP 59 10}
        {GUARDSHIP 54 12}
        {GUARDSHIP 43 8}
        {GUARDSHIP 28 16}
#ifdef NORMAL
        {GUARDSHIP 21 3}
        {GUARDSHIP 42 16}
#endif
#ifdef HARD
        {GUARDSHIP 21 3}
        {GUARDSHIP 42 16}
        {GUARDSHIP 14 14}
        {GUARDSHIP 50 15}
#endif
    [/event]

    [event]
        name=start

        #if you've been to this scenario before, units are unstored. otherwise, they are created
        [if]
            [variable]
                name=started
                equals=yes
            [/variable]
            [then]
                [unstore_unit]
                    variable=shippy
                [/unstore_unit]
                {FOREACH everyoneelse temp}
                    {VARIABLE everyoneelse[$temp].moves 4}
                    [unstore_unit]
                        variable=everyoneelse[$temp]
                    [/unstore_unit]
                {NEXT temp}
                {FOREACH sunkenships temp}
                    [item]
                        x,y=$sunkenships[$temp].x,$sunkenships[$temp].y
                        image="scenery/wreck.png"
                    [/item]
                {NEXT temp}

                [redraw]
                    side=1
                [/redraw]

                [scroll_to_unit]
                    id=The Explorer
                [/scroll_to_unit]
            [/then]
            [else]
                [unit]
                    side=1
                    x,y=59,2
                    type=Black Galleon
                    canrecruit=yes
                    id=The Explorer
                    name= _"The Explorer"
                    random_traits=no
                    {IS_HERO}
                [/unit]

                [redraw]
                    side=1
                [/redraw]

                [scroll_to_unit]
                    id=The Explorer
                [/scroll_to_unit]

                [message]
                    id=The Explorer
                    caption=_ "Madru"
                    image="portraits/Madru.png"
                    message= _ "We have left Elensefar in the hands of the orcs. If we do not return soon, it will be of no use to return at all. We have at most 30 weeks to get to the western lands, where we will meet with the people Black the Red has spoken of. That will leave us with 5 weeks to get back."
                [/message]
                [message]
                    id=The Explorer
                    caption=_ "Madru"
                    image="portraits/Madru.png"
                    message= _ "Also, our ship cannot hold provisions for more than 6 weeks at a time, so we must either land on an island or capture an enemy ship ever 6 weeks."
                [/message]

                [set_variable]	#now it knows you've been here before
                    name=started
                    value=yes
                [/set_variable]
                [set_variable]	#switch to sea battle at end turn?
                    name=seabattle
                    value=no
                [/set_variable]
            [/else]
        [/if]
    [/event]

    #######################################
    #    *********IMPORTANT**********     #
    #PORT_SS *MUST* be followed by PORT_SE#
    #      and PORT_ES by PORT EE         #
    #     or else the tags won't match    #
    #######################################

#wmlindent: start ignoring

#define PORT_SS X Y V
    [event]
        name=start
        #if you have already visited and defeated the island, you capture the village automatically
        [if]
            [variable]
                name={V}.status
                equals=won
            [/variable]
            [then]
                [capture_village]
                    side=1
                    x,y={X},{Y}
                [/capture_village]
                #the macro ends here so that additional stuff (placing of items, etc) can happen
#enddef

#define PORT_SE
            #this is the continuation of the previous macro; the two work like tags
            [/then]
        [/if]
    [/event]
#enddef

#define PORT_ES X Y V
    [event]
        name=moveto

		[filter]
			x,y={X},{Y}
		[/filter]

		#if you've already visited the island, you get a free refill
		[if]
			[variable]
				name={V}.status
				equals=won
			[/variable]
			[then]
			[set_variable]
				name=turnsleft
				value=6
			[/set_variable]
			[message]
				id=The Explorer
				caption=_ "Madru"
				image="portraits/Madru.png"
				message= _ "This island has no more enemies on it, but we can still reprovision here. That will still take time, though."
			[/message]
			[end_turn]
			[/end_turn]
			[/then]
			[else]
			#if you ran away from it before, it displays a different message than if you are there for the first time
			[if]
				[variable]
					name={V}.status
					equals=retreated
				[/variable]
				[then]
				[set_variable]
					name={V}.revisiting
					value=yes
				[/set_variable]
				[message]
					id=The Explorer
					caption=_ "Madru"
					image="portraits/Madru.png"
					message= _ "We have unfinished business to attend to."
				[/message]
				[/then]
				[else]
					[set_variable]
						name={V}.status
						value=won
					[/set_variable]
			#the macro ends here so that additional stuff
            #(mostly messages) can happen
#enddef

#define PORT_EE S
				#this is the continuation of the previous macro;
				#the two work like tags
				[/else]
			[/if]
			[store_unit]
				[filter]
					id=The Explorer
				[/filter]
				variable=shippy
				kill=yes
			[/store_unit]

		# We don't want shippy immobile after scenario restart.
		[set_variable]
			name=shippy.moves
   			value=4
		[/set_variable]
		[store_unit]
		    [filter]
				[not]
					side=1
				[/not]
		    [/filter]
			variable=everyoneelse
		[/store_unit]
		{RESTORE_MENELDUR}
		{WHAT_TURN}
		[endlevel]
		    result=victory
		    linger_mode=no
		    bonus=no
		    next_scenario={S}
		    carryover_add=no
		    carryover_report=no
		    carryover_percentage=100
		[/endlevel]
	    [/else]
	[/if]
    [/event]
#enddef

#wmlindent: stop ignoring

    #when attacked or attacking enemy ship, go into scenario Sea_Battle
    #different map depending on what direction attacked/attacking from

#define ATTACK1
    #first part of sea battle preparation: store current state of this scenario
    [store_unit]
        [filter]
            id=The Explorer
        [/filter]
        variable=shippy
    [/store_unit]
    {WHAT_TURN}
    # We don't want shippy immobile after scenario restart.
    [set_variable]
        name=shippy.moves
        value=4
    [/set_variable]
    [store_unit]
        [filter]
            [not]
                side=1
                [or]
                    x,y=$WESX,$WESY
                [/or]
            [/not]
        [/filter]
        variable=everyoneelse
        kill=yes
    [/store_unit]

    #     #putting a sunken ship on the dead ships
    #     {FOREACH sunkenships temp}
    #         [unstore_unit]
    #             variable=sunkenships[$temp]
    #         [/unstore_unit]
    #     {NEXT temp}

    {VARIABLE_OP i to_variable sunkenships.length}
    {VARIABLE sunkenships[$i].x $WESX}
    {VARIABLE sunkenships[$i].y $WESY}
    {CLEAR_VARIABLE i}

    # trigger to be checked at new turn event
    [set_variable]
        name=seabattle
        value=yes
    [/set_variable]
#enddef

#define ATTACK2
    #second part of sea battle preparation: unstore leader for battle scenario,
    #figure out what map to use, and end level

    [set_variable]
        name=seabattle
        value=no
    [/set_variable]

    {RESTORE_MENELDUR}
    [kill]
        id=The Explorer
    [/kill]

    #finding direction of attack
    {VARIABLE_OP EXPY add -1}

    [store_locations]
        x,y=$EXPX,$EXPY
        radius=1
        variable=north
    [/store_locations]

    {FOREACH_FORMAT north temp}
    [if]
        [variable]
            name=north_temp_x
            numerical_equals=$WESX
        [/variable]
        [variable]
            name=north_temp_y
            numerical_equals=$WESY
        [/variable]
        [then]
            [set_variable]
                name=wesship_north
                value=yes
            [/set_variable]
        [/then]
    [/if]
{NEXT temp}

[if]
    [variable]
        name=EXPX
        numerical_equals=$WESX
    [/variable]
    [then]
        [if]
            [variable]
                name=wesship_north
                equals=yes
            [/variable]
            [then]
                [endlevel]
                    next_scenario=sea_battle_N
                    result=victory
                    save=no
                    linger_mode=no
                    carryover_add=no
                    carryover_report=no
                    carryover_percentage=100
                [/endlevel]
            [/then]
            [else]
                [endlevel]
                    next_scenario=sea_battle_S
                    result=victory
                    save=no
                    linger_mode=no
                    carryover_add=no
                    carryover_report=no
                    carryover_percentage=100
                [/endlevel]
            [/else]
        [/if]
    [/then]
    [else]
        [if]
            [variable]
                name=EXPX
                greater_than=$WESX
            [/variable]
            [then]
                [if]
                    [variable]
                        name=wesship_north
                        equals=yes
                    [/variable]
                    [then]
                        [endlevel]
                            next_scenario=sea_battle_NW
                            result=victory
                            save=no
                            linger_mode=no
                            carryover_add=no
                            carryover_report=no
                            carryover_percentage=100
                        [/endlevel]
                    [/then]
                    [else]
                        [endlevel]
                            next_scenario=sea_battle_SW
                            result=victory
                            save=no
                            linger_mode=no
                            carryover_add=no
                            carryover_report=no
                            carryover_percentage=100
                        [/endlevel]
                    [/else]
                [/if]
            [/then]
            [else]
                [if]
                    [variable]
                        name=wesship_north
                        equals=yes
                    [/variable]
                    [then]
                        [endlevel]
                            next_scenario=sea_battle_NE
                            result=victory
                            save=no
                            linger_mode=no
                            carryover_add=no
                            carryover_report=no
                            carryover_percentage=100
                        [/endlevel]
                    [/then]
                    [else]
                        [endlevel]
                            next_scenario=sea_battle_SE
                            result=victory
                            save=no
                            linger_mode=no
                            carryover_add=no
                            carryover_report=no
                            carryover_percentage=100
                        [/endlevel]
                    [/else]
                [/if]
            [/else]
        [/if]
    [/else]
[/if]
#enddef

    #no turn limit, but turns are limited
    [event]
        name=new turn
        first_time_only=no

        [if]
            # has a sea battle been set up?
            [variable]
                name=seabattle
                equals=yes
            [/variable]
            [then]
                {ATTACK2}
            [/then]
            [else]
                [set_variable]
                    name=gameleft
                    value="$(31-$turn_number)"
                [/set_variable]
                [if]
                    [variable]
                        name=turnsleft
                        greater_than=1
                    [/variable]
                    [then]
                        [message]
                            id=The Explorer
                            caption=_ "Madru"
                            image="portraits/Madru.png"
                            message= _ "We only have enough provisions for $turnsleft weeks; we must reach the Western Lands in $gameleft weeks."
                        [/message]
                        [set_variable]
                            name=turnsleft
                            add=-1
                        [/set_variable]
                    [/then]
                    [else]
                        [if]
                            [variable]
                                name=turnsleft
                                numerical_equals=1
                            [/variable]
                            [then]
                                [message]
                                    id=The Explorer
                                    caption=_ "Madru"
                                    image="portraits/Madru.png"
                                    message= _ "Hurry, we are down to our last provisions! If we don't refill them within a week, we will all starve!"
                                [/message]
                                [set_variable]
                                    name=turnsleft
                                    add=-1
                                [/set_variable]
                            [/then]
                            [else]
                                [message]
                                    id=The Explorer
                                    caption=_ "Madru"
                                    image="portraits/Madru.png"
                                    message= _ "We have ran out of provisions.... *urgh*"
                                [/message]
                                [endlevel]
                                    result=defeat
                                [/endlevel]
                            [/else]
                        [/if]
                    [/else]
                [/if]
            [/else]
        [/if]
    [/event]

    [event]
        name=time over

        [message]
            id=The Explorer
            caption=_ "Black the Red"
            image="portraits/Black_the_Red.png"
            message= _ "We have failed reaching the Westlands in time."
        [/message]

        [endlevel]
            result=defeat
        [/endlevel]
    [/event]

    [event]
        name=attack

        [filter]
            type=Black Galleon
        [/filter]

        [kill]
            x,y=$x2,$y2
        [/kill]

        {VARIABLE_OP EXPX to_variable x1}
        {VARIABLE_OP EXPY to_variable y1}
        {VARIABLE_OP WESX to_variable x2}
        {VARIABLE_OP WESY to_variable y2}
        {ATTACK1}
    [/event]

    [event]
        name=attack

        [filter]
            type=War Galleon
        [/filter]

        [kill]
            x,y=$x1,$y1
        [/kill]

        {VARIABLE_OP EXPX to_variable x2}
        {VARIABLE_OP EXPY to_variable y2}
        {VARIABLE_OP WESX to_variable x1}
        {VARIABLE_OP WESY to_variable y1}
        {ATTACK1}
    [/event]

    ############################
    #put the list of ports here#
    ############################

    #the swampland
    {PORT_SS 50 4 the_swampland}
    {PORT_SE}
    {PORT_ES 50 4 the_swampland}
    [message]
        caption=_ "Meneldur"
        image="portraits/Meneldur.png"
        message= _ "There does not seem to be anyone living on this island... except, it seems, that black-cowled man on the far side..."
    [/message]
    {PORT_EE sea_voyage_1}

    #orc mountain
    {PORT_SS 42 13 orc_mountain}
    {PORT_SE}
    {PORT_ES 42 13 orc_mountain}
    [message]
        caption=_ "Meneldur"
        image="portraits/Meneldur.png"
        message= _ "Last time I was here there was a trading colony, but it seems to be gone. Their old stockades should still be here, anyway."
    [/message]
    {PORT_EE sea_voyage_2}

    #theft / back to the ship
    {PORT_SS 37 7 theft}
    {PORT_SE}
    {PORT_ES 37 7 theft}
    [message]
        caption=_ "Meneldur"
        image="portraits/Meneldur.png"
        message= _ "I think something is in the water..."
    [/message]
    {PORT_EE sea_voyage_3}

    #fire island
    {PORT_SS 28 14 fire_island}
    {PORT_SE}
    {PORT_ES 28 14 fire_island}
    [message]
        caption=_ "Madru"
        image="portraits/Madru.png"
        message= _ "Legend says Haldric landed here on his journey over, and that he fought something. Lets hope we don't have to fight whatever it was..."
    [/message]
    {PORT_EE sea_voyage_5}

    #traitors / deadly alliance
    {PORT_SS 18 11 traitors}
    [item]
        x,y=17,11
        image="units/elves-wood/fighter.png~RC(magenta>green)"
    [/item]
    {PORT_SE}
    {PORT_ES 18 11 traitors}
    [message]
        caption=_ "Meneldur"
        image="portraits/Meneldur.png"
        message= _ "This island looks vaguely elvish."
    [/message]
    {PORT_EE sea_voyage_6}

    #frozen lands
    {PORT_SS 5 5 frozen_lands}
    {PORT_SE}
    {PORT_ES 5 5 frozen_lands}
    [message]
        caption=_ "Meneldur"
        image="portraits/Meneldur.png"
        message= _ "Does anything live in this frozen wasteland?"
    [/message]
    {PORT_EE sea_voyage_8}

    #wesnothian forces / a kings demand / off the isle
    {PORT_SS 40 18 wesnothian_forces}
    [item]
        x,y=39,18
        image="units/human-loyalists/human-spearman.png~RC(magenta>blue)"
    [/item]
    {PORT_SE}
    {PORT_ES 40 18 wesnothian_forces}
    [message]
        caption=_ "Madru"
        image="portraits/Madru.png"
        message= _ "I see signs of a Wesnothian outpost. Odd they would come so far south..."
    [/message]
    {PORT_EE sea_voyage_9}

    #the desert island
    {PORT_SS 17 8 desert_island}
    {PORT_SE}
    {PORT_ES 17 8 desert_island}
    [message]
        caption=_ "Meneldur"
        image="portraits/Meneldur.png"
        message= _ "Nagas were about a hundred years ago, in Haldric's time! I wonder if any remain..."
    [/message]
    {PORT_EE sea_voyage_12}

    #the ruined port
    {PORT_SS 5 17 ruined_port}
    {PORT_SE}
    {PORT_ES 5 17 ruined_port}
    [message]
        caption=_ "Black the Red"
        image="portraits/Black_the_Red.png"
        message= _ "This is old Clearwater Port! It was sacked by orcs long ago, I doubt there are any humans left."
    [/message]
    {PORT_EE sea_voyage_13}

    #blackmore the black
    {PORT_SS 4 12 blackmore_the_black}
    {PORT_SE}
    {PORT_ES 4 12 blackmore_the_black}
    [message]
        id=The Explorer
        caption=_ "Black the Red"
        image="portraits/Black_the_Red.png"
        message= _ "This is the land I was talking about. Land here, and we will get the warriors we need."
    [/message]
    {PORT_EE sea_voyage_14}
[/scenario]
