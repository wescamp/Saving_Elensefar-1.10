#textdomain wesnoth-Saving_Elensefar

[scenario]
    id=sea_voyage_-2
    next_scenario=sea_voyage_0
    name= _ "A Naval Engagement"
    map_data="{~add-ons/Saving_Elensefar/maps/A_Naval_Engagement.map}"
    {TURNS 24 20 18}

    {DEFAULT_SCHEDULE_DAWN}
    {MOOD_BATTLE}
    {VICTORY_AND_DEFEAT_MUSIC}

    {MENELDUR_SIDE}

    [side]
        side=2
        team_name=good
        user_team_name= _"Elensefar's Loyals"
        controller=ai
        id="Black the Red"
        name= _ "Black the Red"
        type=SE Shadow Mage
        canrecruit=yes
        profile="portraits/Black_the_Red.png"
        unrenamable=yes
        [modifications]
            {TRAIT_LOYAL}
            {TRAIT_INTELLIGENT}
        [/modifications]

        recruit=Thief,Thug,SE Civilian,Ruffian
        [filter_recall]
            type={FILTER_OUTLAWS},{BLACK_EXTRA_RECALL},{FILTER_WOOD_WARRIORS}
        [/filter_recall]

        {GOLD 120 100 125}
        {INCOME 2 2 4}

#ifver WESNOTH_VERSION > 1.11.3
        {MICRO_AI_BOTTLENECK_DEFENSE}
#else
                [ai]
                    # avoid the bridge near the enemy
                    {AI_SIMPLE_ALWAYS_ASPECT_VALUE avoid (
                        x=10,12,9,11,10
                        y=16,17,17,18,18
                    )}
        
                    #let him being carefull at day and more reckless at night
                    {AI_SIMPLE_DAY_ASPECT aggression ("-0.1")}
                    {AI_SIMPLE_DAY_ASPECT caution ("0.9")}
                    {AI_SIMPLE_DAY_ASPECT leader_aggression ("-999")}
        
                    {AI_SIMPLE_NIGHT_ASPECT leader_aggression ("-1.5")}
                    {AI_SIMPLE_NIGHT_ASPECT aggression ("0.7")}
                    {AI_SIMPLE_NIGHT_ASPECT caution ("0.9")}
        
                    {AI_SIMPLE_ALWAYS_ASPECT village_value 0}
                    {AI_SIMPLE_ALWAYS_ASPECT support_villages yes}
                    {AI_SIMPLE_ALWAYS_ASPECT grouping defensive}
        
                [/ai]
#endif
        {FLAG_VARIANT long}
    [/side]
    {RANDOM_RECRUITS 2 3 ("Thief,Thug,SE Civilian,Ruffian") ("Thief,Thug,SE Civilian,Ruffian") ("Thief,Thug,SE Civilian,Ruffian")}
    {DISABLE_UPKEEP 2}

    [side]
        side=3
        controller=ai
        team_name=bad
        user_team_name= _"Wesnothians"
        id=Aldran
        name= _ "Aldran"
        type=Master at Arms
        canrecruit=yes
        recruit="Spearman,Bowman,Mage,Young Ogre,Fencer"
        {GOLD 160 200 260}
        {INCOME 5 6 8}
        {FLAG_VARIANT loyalist}
        [ai]
            grouping=offensive
            aggression=0.5
            caution=0.7
            village_value=0.0
            support_villages=yes
            {ATTACK_DEPTH 4 5 6}
            {NO_SCOUTS}
        [/ai]
        {PASSIVE_LEADER 3}
        {PROTECT location (x,y=15,18)}
    [/side]

    {LIMIT_RECRUITS 3 ("Young Ogre") 1}

#ifdef EASY
    {LIMIT_CONTEMPORANEOUS_RECRUITS 3 ("Fencer") 1}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 3 ("Mage") 2}
#else
    {LIMIT_CONTEMPORANEOUS_RECRUITS 3 ("Fencer") 2}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 3 ("Mage") 3}
#endif

    {LIMIT_CONTEMPORANEOUS_RECRUITS 3 ("Spearman") 6}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 3 ("Bowman") 4}

    [event]
        name=prestart

        [objectives]
            side=1
            [objective]
                description= _ "Defeat enemy leader"
                condition=win
            [/objective]
            [objective]
                description= _ "Death of Meneldur"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Madru"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Black the Red"
                condition=lose
            [/objective]
            {TURNS_RUN_OUT}
        [/objectives]

        [set_recruit]
            side=1
            recruit=""
        [/set_recruit]

        [fire_event]
            name=supply_calculation
        [/fire_event]

#ifver WESNOTH_VERSION > 1.11.3
        # NOTE: there are no healers in this scenario
        [micro_ai]
            side=2
            action=add
            ai_type=bottleneck_defense

            x=8,9
            y=17,19
            enemy_x=9,10
            enemy_y=17,18
            # let us suppose there is one :P (2 villages adjacent)
            healer_x,healer_y=6,19
            # Black_the_Red is fragile, but let him engage in combat nevertheless
            active_side_leader=yes
        [/micro_ai]
#endif
    [/event]

    {DEATHS_SEA}

#define GUARD SIDE TYPE X Y
    [unit]
        type={TYPE}
        side={SIDE}
        x,y={X},{Y}
        moves=0
        ai_special=guardian
        [modifications]
            {TRAIT_LOYAL}
            {TRAIT_STRONG}
        [/modifications]
        {IS_LOYAL}
    [/unit]
#enddef

    [event]
        name=start

        {GUARD 2 Thug 6 18}
        [+unit]
            experience=18
        [/unit]
        {GUARD 2 Rogue 6 20}
        {GUARD 3 ("Heavy Infantryman") 14 13}
        {GUARD 3 Spearman 11 16}
#ifndef EASY
        {GUARD 3 Spearman 16 14}
        {GUARD 3 ("Young Ogre") 13 17}
#endif

#ifdef HARD
        {SEARCH_NEAREST 2 (*^Wyb) ()}
        {GUARD 3 ("White Mage") $loc.x $loc.y}
#endif

        {SEARCH_NEAREST 1 (*^Wyb) (id=Meneldur)}
        [recall]
            type={FILTER_LOYALISTS}
            x,y=$loc.x,$loc.y
            fire_event=yes
        [/recall]

        {SEARCH_NEAREST 1 (*^Wyb) (id=Meneldur)}
        [recall]
            id=Madru
            x,y=$loc.x,$loc.y
            fire_event=yes
        [/recall]
        {CLEAR_VARIABLE loc}

        [message]
            id=Meneldur
            message= _ "Why do you stop us? We seek help. I come from Elensefar, which, as far as we can tell, was just captured by orcs!"
        [/message]
        [message]
            id=Aldran
            message= _ "You are interfering with our mission; we are trying to chase down this magician pirate."
        [/message]
        [message]
            id="Black the Red"
            message= _ "I'm not a pirate! I also come from Elensefar, and I must have left port a few days before it was attacked. This is the first I've heard of it."
        [/message]
        [message]
            id=Aldran
            message= _ "You dog, don't bother us with your lies! You attacked a ship of the Royal Navy with your spells, and now you will pay for it!"
        [/message]
        [message]
            id=Meneldur
            message= _ "I need loyal warriors from Elensefar to help me on my quest. Black the Red, do you want to join me in retaking Elensefar from these orcs?"
        [/message]
        [message]
            id=Aldran
            message= _ "Outlaws, you mean! These Elensians are all the same. Troops, destroy them!"
        [/message]
        [message]
            id=Meneldur
            message= _ "Why is a ship from Elensefar carrying bandits and thieves?"
        [/message]
        [message]
            id="Black the Red"
            message= _ "They come from the... less _wealthy_ parts of Elensefar. But they are still fiercely loyal to it. They will be good fighters. I will join, if you'll have me."
        [/message]
        [message]
            id=Meneldur
            message= _ "Very well. Thats not so different from my own crew. Aldran - we will not fight you if you do not attack us, but you must let us go on our way."
        [/message]
        [message]
            id=Aldran
            message= _ "Ha! I will bring you and your ally in to Weldyn to be tried for treason. And it does not matter it is two boats to one; I have already sent a boat to inform the King, and get reinforcements."
        [/message]
        [message]
            id=Madru
            message= _ "Remember, crew, the healing grog is stored in those barrels."
        [/message]
        {VARIABLE healedyet no}
    [/event]

    [event]
        name=side turn
        first_time_only=no

        [store_unit]
            [filter]
                side=$side_number
                [and]
                    [filter_location]
                        terrain=*^Wyb
                    [/filter_location]
                [/and]
            [/filter]
            variable=temp
        [/store_unit]

        {FOREACH temp i}
			[if]
				{VARIABLE_CONDITIONAL temp[$i].hitpoints less_than $temp[$i].max_hitpoints}
                [then]
                    [if]
						{VARIABLE_CONDITIONAL healedyet not_equals yes}
                        [then]
                            [message]
                                id=$temp.id
                                message= _ "Ah, some nice, refreshing grog! *gulp*"
                            [/message]
                            [message]
                                speaker=narrator
                                message= _ "Drinking the grog heals $temp.name|!"
                                image=wesnoth-icon.png
                            [/message]
                            {VARIABLE healedyet yes}
                        [/then]
                    [/if]
                [/then]
            [/if]
        {NEXT i}
        {CLEAR_VARIABLE temp}
    [/event]

    [event]
        name=recall
        first_time_only=no

        [filter]
            side=1
        [/filter]

        [modify_unit]
			[filter]
				x,y=$x1,$y1
			[/filter]
			moves=0
		[/modify_unit]
    [/event]

    # 'recruit' one Outlaw
    [event]
        name=side 2 turn

        [unit]
            side=2
            type=Outlaw
            placement=leader
            animate=yes
            moves=0
        [/unit]
    [/event]

    [event]
        name=enemies defeated

        [message]
            id="Black the Red"
            message= _ "Well, what is it anyway that you people want? Why did you help us?"
        [/message]
        [message]
            id=Meneldur
            message= _ "We go out to sea, to build up an army large enough to retake Elensefar. You're an Elensian, right? I think you owe us your help. We did just save you from death, and now we have the men of Wesnoth against us in return."
        [/message]
        [message]
            id="Black the Red"
            message= _ "Well, I have been in Elensefar, and owe some help to it. Very well. Here is what I will do. There is an island in the west that has many warriors on it who will be willing to help you; I will join you, and try to convince those warriors to also, if you grant me one request."
        [/message]
        [message]
            id=Madru
            message= _ "Which is?"
        [/message]
        [message]
            id="Black the Red"
            message= _ "I can't tell you until we reach the Western isle I told you about. That's part of the fun."
        [/message]
        [message]
            id=Meneldur
            message= _ "Oh, fine... 'I swear on Elensefar my city and on my honor as a Sailor that I will honor your request, whatever it may be, whenever we reach this Western island and you secure the help of the warriors that live there.' Happy?"
        [/message]
        [message]
            id="Black the Red"
            message= _ "Very much so. Now, I will move my troops to your boat (it is faster), and we will head on west..."
        [/message]

        [modify_unit]
            [filter]
                side=2
            [/filter]
            side=1
            experience="$($this_unit.experience+8)"
        [/modify_unit]

        [store_gold]
            side=2
        [/store_gold]
        [gold]
            side=1
            amount="$gold"
        [/gold]
        {CLEAR_VARIABLE gold,healedyet,temp,heal_amount}

        {SE_ENDLEVEL yes yes}
    [/event]
[/scenario]

#undef GUARD SIDE TYPE X Y
