#textdomain wesnoth-Saving_Elensefar

[scenario]
    id=sea_voyage_-2
    next_scenario=sea_voyage_0
    name= _ "A Naval Engagement"
    map_data="{~add-ons/Saving_Elensefar/maps/A_Naval_Engagement.map}"
    {TURNS 24 20 18}

    {DEFAULT_SCHEDULE_DAWN}
    {MOOD_BATTLE}
    {VICTORY_AND_DEFEAT_MUSIC}

    {MENELDUR_SIDE}
#ifndef EXPERIMENTAL
    [+side]
        {GOLD 200 175 150}
        income=-1
    [/side]
#endif

    [side]
        side=2
        team_name=good
        user_team_name= _"Elensefar's Loyals"
        controller=ai
        id="Black the Red"
        name= _ "Black the Red"
        type=SE Shadow Mage
        canrecruit=yes
        profile="portraits/Black_the_Red.png"
        unrenamable=yes
        [modifications]
            {TRAIT_LOYAL}
            {TRAIT_INTELLIGENT}
        [/modifications]
        recruit=Thief,Thug,SE Civilian,Ruffian
#ifdef EXPERIMENTAL
        [filter_recall]
            type={FILTER_OUTLAWS},{BLACK_EXTRA_RECALL},{FILTER_WOOD_WARRIORS}
        [/filter_recall]
#else
        {IS_HERO}
#endif
        {GOLD 120 100 125}
        {INCOME 2 2 4}
        [ai]
            #avoid the bridge near the enemy
            {AI_SIMPLE_ALWAYS_ASPECT_VALUE avoid (
                x=10,12,9,11,10
                y=16,17,17,18,18
            )}

            #let him being carefull at day and more reckless at night
            {AI_SIMPLE_DAY_ASPECT aggression ("-0.1")}
            {AI_SIMPLE_DAY_ASPECT caution ("0.9")}
            {AI_SIMPLE_DAY_ASPECT leader_aggression ("-12")}

            {AI_SIMPLE_NIGHT_ASPECT leader_aggression ("1.25")}
            {AI_SIMPLE_NIGHT_ASPECT aggression ("0.8")}
            {AI_SIMPLE_NIGHT_ASPECT caution ("0.4")}

            {AI_SIMPLE_ALWAYS_ASPECT village_value 0}
            {AI_SIMPLE_ALWAYS_ASPECT support_villages yes}
            {AI_SIMPLE_ALWAYS_ASPECT grouping defensive}

            ##dump ally
#ifdef EASY
            {AI_SIMPLE_ALWAYS_ASPECT attack_depth 4}
#endif

#ifdef NORMAL
            {AI_SIMPLE_ALWAYS_ASPECT attack_depth 3}
#endif

#ifdef HARD
            {AI_SIMPLE_ALWAYS_ASPECT attack_depth 1}
#endif
        [/ai]
        {FLAG_VARIANT long}
    [/side]
    {RANDOM_RECRUITS 2 3 ("Thief,Thug,SE Civilian,Ruffian") ("Thief,Thug,SE Civilian,Ruffian") ("Thief,Thug,SE Civilian,Ruffian")}
    {DISABLE_UPKEEP 2}

    [side]
        side=3
        controller=ai
        team_name=bad
        user_team_name= _"Wesnothians"
        id=Aldran
        name= _ "Aldran"
        type=Master at Arms
        canrecruit=yes
        recruit="Spearman,Bowman,Mage,Young Ogre,Fencer"
        {GOLD 160 200 260}
        {INCOME 5 6 8}
        {FLAG_VARIANT loyalist}
        [ai]
            grouping=offensive
            aggression=0.5
            caution=0.7
            village_value=0.0
            support_villages=yes
            {ATTACK_DEPTH 4 5 6}
            {NO_SCOUTS}
        [/ai]
        {PASSIVE_LEADER 3}
        {PROTECT location (x,y=15,18)}
    [/side]

    {LIMIT_RECRUITS 3 ("Young Ogre") 1}

#ifdef EASY
    {LIMIT_CONTEMPORANEOUS_RECRUITS 3 ("Fencer") 1}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 3 ("Mage") 2}
#else
    {LIMIT_CONTEMPORANEOUS_RECRUITS 3 ("Fencer") 2}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 3 ("Mage") 3}
#endif

    {LIMIT_CONTEMPORANEOUS_RECRUITS 3 ("Spearman") 6}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 3 ("Bowman") 4}

    [event]
        name=prestart

        [objectives]
            side=1
            [objective]
                description= _ "Defeat enemy leader"
                condition=win
            [/objective]
            [objective]
                description= _ "Death of Meneldur"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Madru"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Black the Red"
                condition=lose
            [/objective]
            {TURNS_RUN_OUT}
        [/objectives]

        [set_recruit]
            side=1
            recruit=""
        [/set_recruit]

        [fire_event]
            name=supply_calculation
        [/fire_event]
    [/event]

    {DEATHS_SEA}

#define GUARD SIDE TYPE X Y
    [unit]
        type={TYPE}
        side={SIDE}
        x,y={X},{Y}
        moves=0
        ai_special=guardian
        [modifications]
            {TRAIT_LOYAL}
            {TRAIT_STRONG}
        [/modifications]
        {IS_LOYAL}
    [/unit]
#enddef

    [event]
        name=start

        {GUARD 2 Thug 6 18}
        [+unit]
            experience=18
        [/unit]
        {GUARD 2 Rogue 6 20}
        {GUARD 3 ("Heavy Infantryman") 14 13}
        {GUARD 3 Spearman 11 16}
#ifndef EASY
        {GUARD 3 Spearman 16 14}
        {GUARD 3 ("Young Ogre") 13 17}
#endif

#ifdef HARD
        {SEARCH_NEAREST 2 (*^Wyb) ()}
        {GUARD 3 ("White Mage") $loc.x $loc.y}
#endif

        {SEARCH_NEAREST 1 (*^Wyb) (id=Meneldur)}
        [recall]
            type={FILTER_LOYALISTS}
            x,y=$loc.x,$loc.y
            fire_event=yes
        [/recall]

        {SEARCH_NEAREST 1 (*^Wyb) (id=Meneldur)}
        [recall]
            id=Madru
            x,y=$loc.x,$loc.y
            fire_event=yes
        [/recall]
        {CLEAR_VARIABLE loc}

        [message]
            id=Meneldur
            message= _ "Why do you stop us? We seek help. I come from Elensefar, which, as far as we can tell, was just captured by orcs!"
        [/message]
        [message]
            id=Aldran
            message= _ "You are interfering with our mission; we are trying to chase down this magician pirate."
        [/message]
        [message]
            id="Black the Red"
            message= _ "I'm not a pirate! I also come from Elensefar, and I must have left port a few days before it was attacked. This is the first I've heard of it."
        [/message]
        [message]
            id=Aldran
            message= _ "You dog, don't bother us with your lies! You attacked a ship of the Royal Navy with your spells, and now you will pay for it!"
        [/message]
        [message]
            id=Meneldur
            message= _ "I need loyal warriors from Elensefar to help me on my quest. Black the Red, do you want to join me in retaking Elensefar from these orcs?"
        [/message]
        [message]
            id=Aldran
            message= _ "Outlaws, you mean! These Elensians are all the same. Troops, destroy them!"
        [/message]
        [message]
            id=Meneldur
            message= _ "Why is a ship from Elensefar carrying bandits and thieves?"
        [/message]
        [message]
            id="Black the Red"
            message= _ "They come from the... less _wealthy_ parts of Elensefar. But they are still fiercely loyal to it. They will be good fighters. I will join, if you'll have me."
        [/message]
        [message]
            id=Meneldur
            message= _ "Very well. Thats not so different from my own crew. Aldran - we will not fight you if you do not attack us, but you must let us go on our way."
        [/message]
        [message]
            id=Aldran
            message= _ "Ha! I will bring you and your ally in to Weldyn to be tried for treason. And it does not matter it is two boats to one; I have already sent a boat to inform the King, and get reinforcements."
        [/message]
        [message]
            id=Madru
            message= _ "Remember, crew, the healing grog is stored in those barrels."
        [/message]
        {VARIABLE healedyet no}
    [/event]

    [event]
        name=side turn
        first_time_only=no

        [store_unit]
            [filter]
                side=$side_number
                [and]
                    [filter_location]
                        terrain=*^Wyb
                    [/filter_location]
                [/and]
            [/filter]
            variable=temp
        [/store_unit]

        {FOREACH temp i}
            {IF_VAR temp[$i].hitpoints less_than $temp[$i].max_hitpoints (
                [then]
                    [if]
                        [variable]
                            name=healedyet
                            not_equals=yes
                        [/variable]
                        [then]
                            [message]
                                id=$temp.id
                                message= _ "Ah, some nice, refreshing grog! *gulp*"
                            [/message]
                            [message]
                                speaker=narrator
                                message= _ "Drinking the grog heals $temp.name|!"
                                image=wesnoth-icon.png
                            [/message]
                            {VARIABLE healedyet yes}
                        [/then]
                    [/if]
                [/then]
            )}
        {NEXT i}
        {CLEAR_VARIABLE temp}
    [/event]

    [event]
        name=recall
        first_time_only=no

        [filter]
            side=1
        [/filter]

        {MODIFY_UNIT (x,y=$x1,$y1) moves 0}
    [/event]

    # 'recruit' one Outlaw
    [event]
        name=side 2 turn

        [unit]
            side=2
            type=Outlaw
            placement=leader
            animate=yes
            moves=0
        [/unit]
    [/event]

    #    # force Black the Red using a mixed force
    #     [event]
    #         name=recruit
    #         first_time_only=no
    #
    #         [filter]
    #             side=2
    #         [/filter]
    #
    #         [switch]
    #             variable=unit.type
    #             [case]
    #                 value=Thief
    #                 {VARIABLE_OP thieves add 1}
    #             [/case]
    #             [case]
    #                 value=Thug
    #                 {VARIABLE_OP thugs add 1}
    #             [/case]
    #         [/switch]
    #
    #         {IF_VAR thieves greater_than 2 (
    #             [then]
    #                 {VARIABLE thieves 0}
    #                 [disallow_recruit]
    #                     side=2
    #                     type=Thief,SE Civilian
    #                 [/disallow_recruit]
    #                 [allow_recruit]
    #                     side=2
    #                     type=Thug,Ruffian
    #                 [/allow_recruit]
    #             [/then]
    #         )}
    #
    #         {IF_VAR thugs greater_than 3 (
    #             [then]
    #                 {VARIABLE thugs 0}
    #                 [disallow_recruit]
    #                     side=2
    #                     type=Thug,Ruffian
    #                 [/disallow_recruit]
    #                 [allow_recruit]
    #                     side=2
    #                     type=Thief,SE Civilian
    #                 [/allow_recruit]
    #             [/then]
    #         )}
    #     [/event]

    [event]
        name=enemies defeated

        [message]
            id="Black the Red"
            message= _ "Well, what is it anyway that you people want? Why did you help us?"
        [/message]
        [message]
            id=Meneldur
            message= _ "We go out to sea, to build up an army large enough to retake Elensefar. You're an Elensian, right? I think you owe us your help. We did just save you from death, and now we have the men of Wesnoth against us in return."
        [/message]
        [message]
            id="Black the Red"
            message= _ "Well, I have been in Elensefar, and owe some help to it. Very well. Here is what I will do. There is an island in the west that has many warriors on it who will be willing to help you; I will join you, and try to convince those warriors to also, if you grant me one request."
        [/message]
        [message]
            id=Madru
            message= _ "Which is?"
        [/message]
        [message]
            id="Black the Red"
            message= _ "I can't tell you until we reach the Western isle I told you about. That's part of the fun."
        [/message]
        [message]
            id=Meneldur
            message= _ "Oh, fine... 'I swear on Elensefar my city and on my honor as a Sailor that I will honor your request, whatever it may be, whenever we reach this Western island and you secure the help of the warriors that live there.' Happy?"
        [/message]
        [message]
            id="Black the Red"
            message= _ "Very much so. Now, I will move my troops to your boat (it is faster), and we will head on west..."
        [/message]

        [store_unit]
            [filter]
                side=2
            [/filter]
            variable=switchside
        [/store_unit]

        {FOREACH switchside i}
#ifndef EXPERIMENTAL
            {VARIABLE switchside[$i].canrecruit no}
#endif
            {VARIABLE switchside[$i].side 1}
            {VARIABLE_OP switchside[$i].experience add 8}
            [unstore_unit]
                variable=switchside[$i]
                fire_event=yes
            [/unstore_unit]
        {NEXT i}

#ifdef EXPERIMENTAL
        # meaningless since in the next scenario it is cleared anyway
        [allow_extra_recruit]
            id="Black the Red"
            extra_recruit=Ruffian,SE Civilian,Thug,Thief
        [/allow_extra_recruit]
#endif
        [store_gold]
            side=2
        [/store_gold]
        [gold]
            side=1
            amount="$gold"
        [/gold]
        {CLEAR_VARIABLE switchside,gold,healedyet,thieves,thugs,temp,heal_amount}

        {SE_ENDLEVEL yes yes}
    [/event]

#define SAVE_LOC
    x=2-5,4,6
    y=5-22,15,16
    [not]
        terrain=Xu
    [/not]
    [not]
        [filter]
        [/filter]
    [/not]
#enddef

    # make the ai ally retreat if wounded
    [event]
        name=side 2 turn refresh
        first_time_only=no

        [store_unit]
            [filter]
                side=$side_number
                canrecruit=no
                [not]
                    [filter_wml]
                        [status]
                            retreated=yes
                        [/status]
                    [/filter_wml]
                [/not]
            [/filter]
            variable=consider_retreating
        [/store_unit]

        [store_unit]
            [filter]
                side=$side_number
                canrecruit=no
                [filter_wml]
                    [status]
                        retreated=yes
                    [/status]
                [/filter_wml]
            [/filter]
            variable=retreated
        [/store_unit]

        {FOREACH retreated i}
            ##ifndef HARD
            [heal_unit]
                [filter]
                    id=$retreated[$i].id
                [/filter]
                amount=4
                animate=yes
            [/heal_unit]
            ##endif
            {IF_VAR retreated[$i].hitpoints less_than "$($retreated[$i].max_hitpoints-4)" (
                [then]
                    [store_reachable_locations]
                        [filter]
                            id=$retreated[$i].id
                        [/filter]
                        [filter_location]
                            terrain=*^Wyb
                            [not]
                                [filter]
                                [/filter]
                            [/not]
                        [/filter_location]
                        range=movement
                        moves=current
                        variable=possible_loc
                    [/store_reachable_locations]
                    {IF_VAR possible_loc.length not_equals 0 (
                        [then]
                            [move_unit]
                                id=$retreated[$i].id
                                to_x=$possible_loc[0].x
                                to_y=$possible_loc[0].y
                                fire_event=no
                            [/move_unit]
                            {VARIABLE retreated[$i].x $possible_loc[0].x}
                            {VARIABLE retreated[$i].y $possible_loc[0].y}
                        [/then]
                    )}

                    {VARIABLE retreated[$i].moves 0}
                    {VARIABLE retreated[$i].attacks_left 0}
                    #{VARIABLE retreated[$i].resting yes}
                [/then]
                [else]
                    {CLEAR_VARIABLE retreated[$i].status.retreated}
                [/else]
            )}
            [unstore_unit]
                variable=retreated[$i]
                find_vacant=no
            [/unstore_unit]
        {NEXT i}

        {FOREACH consider_retreating i}
            {IF_VAR consider_retreating[$i].hitpoints less_than_equal_to "$($consider_retreating[$i].max_hitpoints/2)" (
                [then]
                    {IF_VAR consider_retreating[$i].x less_than_equal_to 9 (
                        [then]
                            [store_reachable_locations]
                                [filter]
                                    id=$consider_retreating[$i].id
                                [/filter]
                                [filter_location]
                                    {SAVE_LOC}
                                    [not]
                                        terrain=Ke,Ce
                                    [/not]
                                [/filter_location]
                                range=movement
                                moves=current
                                variable=possible_loc
                            [/store_reachable_locations]

                            {IF_VAR possible_loc.length equals 0 (
                                [then]
                                    [store_reachable_locations]
                                        [filter]
                                            id=$consider_retreating[$i].id
                                        [/filter]
                                        [filter_location]
                                            {SAVE_LOC}
                                        [/filter_location]
                                        range=movement
                                        moves=current
                                        variable=possible_loc
                                    [/store_reachable_locations]
                                [/then]
                            )}

                            {IF_VAR possible_loc.length not_equals 0 (
                                [then]
                                    {VARIABLE_OP random rand(1..$possible_loc.length)}
                                    {VARIABLE_OP random sub 1}
                                    #{DEBUG_MSG (I will move to $possible_loc[$random].x, $possible_loc[$random].y)}
                                    [move_unit]
                                        id=$consider_retreating[$i].id
                                        to_x=$possible_loc[$random].x
                                        to_y=$possible_loc[$random].y
                                        fire_event=no
                                    [/move_unit]
                                    {VARIABLE consider_retreating[$i].x $possible_loc[$random].x}
                                    {VARIABLE consider_retreating[$i].y $possible_loc[$random].y}
                                    {VARIABLE consider_retreating[$i].status.retreated yes}
                                    {VARIABLE retreated[$i].resting yes}
                                    {VARIABLE consider_retreating[$i].moves 0}
                                    {VARIABLE consider_retreating[$i].attacks_left 0}
                                [/then]
                                [else]
                                    [store_reachable_locations]
                                        [filter]
                                            id=$consider_retreating[$i].id
                                        [/filter]
                                        [filter_location]
                                            terrain=*^Wyb
                                            [not]
                                                [filter]
                                                [/filter]
                                            [/not]
                                        [/filter_location]
                                        range=movement
                                        moves=current
                                        variable=possible_loc
                                    [/store_reachable_locations]

                                    {IF_VAR possible_loc.length not_equals 0 (
                                        [then]
                                            [move_unit]
                                                id=$consider_retreating[$i].id
                                                to_x=$possible_loc[0].x
                                                to_y=$possible_loc[0].y
                                                fire_event=no
                                            [/move_unit]
                                            {VARIABLE consider_retreating[$i].x $possible_loc[0].x}
                                            {VARIABLE consider_retreating[$i].y $possible_loc[0].y}
                                            {VARIABLE consider_retreating[$i].status.retreated yes}
                                            {VARIABLE retreated[$i].resting yes}
                                            {VARIABLE consider_retreating[$i].moves 0}
                                            {VARIABLE consider_retreating[$i].attacks_left 0}
                                        [/then]
                                    )}
                                [/else]
                            )}
                        [/then]
                        [else]
                            [store_reachable_locations]
                                [filter]
                                    id=$consider_retreating[$i].id
                                [/filter]
                                [filter_location]
                                    terrain=*^Wyb
                                    [not]
                                        [filter]
                                        [/filter]
                                    [/not]
                                [/filter_location]
                                range=movement
                                moves=current
                                variable=possible_loc
                            [/store_reachable_locations]

                            {IF_VAR possible_loc.length equals 0 (
                                [then]
                                    [store_reachable_locations]
                                        [filter]
                                            side=3
                                        [/filter]
                                        #[filter_location]
                                        #    x,y=1-999,1-999
                                        #[/filter_location]
                                        range=attack
                                        moves=max
                                        variable=enemy_can_reach
                                    [/store_reachable_locations]
                                    [store_reachable_locations]
                                        [filter]
                                            id=$consider_retreating[$i].id
                                        [/filter]
                                        [filter_location]
                                            x,y=1-999,1-999
                                            [not]
                                                find_in=enemy_can_reach
                                            [/not]
                                        [/filter_location]
                                        range=movement
                                        moves=current
                                        variable=possible_loc
                                    [/store_reachable_locations]

                                    {IF_VAR possible_loc.length not_equals 0 (
                                        [then]
                                            {VARIABLE_OP random rand(1..$possible_loc.length)}
                                            {VARIABLE_OP random sub 1}
                                            [move_unit]
                                                id=$consider_retreating[$i].id
                                                to_x=$possible_loc[$random].x
                                                to_y=$possible_loc[$random].y
                                                fire_event=no
                                            [/move_unit]
                                            {VARIABLE consider_retreating[$i].x $possible_loc[$random].x}
                                            {VARIABLE consider_retreating[$i].y $possible_loc[$random].y}
                                            #{VARIABLE consider_retreating[$i].status.retreated yes}
                                            {VARIABLE consider_retreating[$i].moves 0}
                                            {VARIABLE consider_retreating[$i].attacks_left 0}
                                        [/then]
                                    )}
                                [/then]
                            )}
                        [/else]
                    )}
                [/then]
            )}
            [unstore_unit]
                variable=consider_retreating[$i]
                find_vacant=no
            [/unstore_unit]
        {NEXT i}
        {CLEAR_VARIABLE consider_retreating,reachable,possible_loc,random,enemy_can_reach,retreated}
    [/event]
[/scenario]

#undef GUARD SIDE TYPE X Y
#undef SAVE_LOC
